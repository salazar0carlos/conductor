name: Dependency Update Check

# Run weekly to catch breaking dependency updates early
on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:
  # Run on PRs that update dependencies
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'

jobs:
  check-dependencies:
    name: Test Dependency Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install current dependencies
        run: npm ci

      - name: Run validation with current deps
        run: npm run validate

      - name: Test build with current deps
        run: npm run build

      - name: Check for outdated dependencies
        id: outdated
        run: |
          npm outdated --json > outdated.json || true
          cat outdated.json

      - name: Update to latest compatible versions
        run: |
          # Update to latest within semver range
          npm update
          npm install

      - name: Run validation after update
        run: npm run validate

      - name: Test build after update
        run: npm run build

      - name: Report results
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            let outdatedDeps = '{}'
            try {
              outdatedDeps = fs.readFileSync('outdated.json', 'utf8')
            } catch (e) {
              // File might not exist
            }

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Dependency Update Breaking Build',
              labels: ['dependencies', 'bug', 'critical'],
              body: `## Dependency Update Broke Build

A weekly dependency check has detected that updating dependencies breaks the build.

### Outdated Dependencies
\`\`\`json
${outdatedDeps}
\`\`\`

### Action Required
1. Review the failed workflow logs
2. Identify which dependency update caused the failure
3. Check if it's a breaking change in the dependency
4. Update code to be compatible OR pin the dependency version

### Workflow Run
${context.payload.repository.html_url}/actions/runs/${context.runId}

**This is a critical infrastructure issue - must be resolved ASAP.**
            })

  test-major-updates:
    name: Test Major Dependency Updates (Manual)
    runs-on: ubuntu-latest
    # Only run manually - major updates are risky
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install current dependencies
        run: npm ci

      - name: Check for major updates
        run: |
          npx npm-check-updates --target latest --format json > major-updates.json
          cat major-updates.json

      - name: Update to latest versions (including breaking)
        run: |
          npx npm-check-updates -u
          npm install

      - name: Run validation after major update
        continue-on-error: true
        run: npm run validate

      - name: Test build after major update
        continue-on-error: true
        run: npm run build

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: major-update-results
          path: |
            major-updates.json
            package.json
            package-lock.json
